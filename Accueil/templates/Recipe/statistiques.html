{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
    <h2 class="text-center mb-4">
        <i class="bi bi-speedometer2 me-2"></i> Tableau de bord
    </h2>

    <!-- Cartes statistiques en haut -->
    <div class="row mb-4 g-4">
        <!-- Nombre total de recettes -->
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center h-100 dashboard-card">
                <div class="card-header bg-primary-culinaire text-white py-2">
                    <i class="bi bi-journal-text me-2"></i> Recettes publiées
                </div>
                <div class="card-body">
                    <p class="display-5 mb-0">{{ total_recettes }}</p>
                </div>
            </div>
        </div>

        <!-- Likes reçus -->
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center h-100 dashboard-card">
                <div class="card-header bg-success-culinaire text-white py-2">
                    <i class="bi bi-hand-thumbs-up me-2"></i> Likes reçus
                </div>
                <div class="card-body">
                    <p class="display-5 mb-0">{{ total_likes }}</p>
                </div>
            </div>
        </div>

        <!-- Favoris -->
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center h-100 dashboard-card">
                <div class="card-header bg-warning-culinaire text-white py-2">
                    <i class="bi bi-heart me-2"></i> En favoris
                </div>
                <div class="card-body">
                    <p class="display-5 mb-0">{{ total_favoris }}</p>
                </div>
            </div>
        </div>

        <!-- Note moyenne -->
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center h-100 dashboard-card">
                <div class="card-header bg-info-culinaire text-white py-2">
                    <i class="bi bi-star me-2"></i> Note moyenne
                </div>
                <div class="card-body">
                    <p class="display-5 mb-0">{{ avg_rating|floatformat:1 }} <small>/5</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques et listes -->
    <div class="row g-4">
        <!-- Répartition par Catégorie -->
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm border-0 h-100 dashboard-card">
                <div class="card-header text-white py-2 px-3 bg-secondary-culinaire">
                    <i class="bi bi-pie-chart me-2"></i> Répartition par Catégorie
                </div>
                <div class="card-body">
                    <canvas id="catChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Recettes par Mois -->
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm border-0 h-100 dashboard-card">
                <div class="card-header text-white py-2 px-3 bg-primary-culinaire">
                    <i class="bi bi-calendar3 me-2"></i> Recettes par Mois
                </div>
                <div class="card-body">
                    <canvas id="moisChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Évolution des Likes par Mois -->
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm border-0 h-100 dashboard-card">
                <div class="card-header text-white py-2 px-3 bg-success-culinaire">
                    <i class="bi bi-graph-up-arrow me-2"></i> Likes par Mois
                </div>
                <div class="card-body">
                    <canvas id="likesChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Top 5 Recettes Populaires -->
        <div class="col-md-6 col-lg-6">
            <div class="card shadow-sm border-0 h-100 dashboard-card">
                <div class="card-header text-white py-2 px-3 bg-danger-culinaire">
                    <i class="bi bi-fire me-2"></i> Top 5 Recettes Populaires
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Recette</th>
                                    <th class="text-end">Likes</th>
                                    <th class="text-end">Favoris</th>
                                </tr>
                            </thead>
                            <!-- Table -->
<tbody>
    {% for recipe in recettes_populaires %}
        <tr>
            <td>
                <a href="#" 
                   class="text-decoration-none" 
                   data-bs-toggle="modal" 
                   data-bs-target="#recipeModal{{ recipe.id }}">
                    {{ recipe.title }}
                </a>
            </td>
            <td class="text-end">{{ recipe.likes_count }} <i class="bi bi-hand-thumbs-up text-primary-culinaire"></i></td>
            <td class="text-end">{{ recipe.fav_count }} <i class="bi bi-heart text-danger-culinaire"></i></td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="3" class="text-center">Aucune recette likée</td>
        </tr>
    {% endfor %}
</tbody>

<!-- Modals (outside the table) -->
{% for recipe in recettes_populaires %}
    <div class="modal fade" id="recipeModal{{ recipe.id }}" tabindex="-1" aria-labelledby="recipeModalLabel{{ recipe.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 rounded-3 overflow-hidden shadow-lg">
                <div class="modal-body p-0 d-flex flex-column flex-md-row">
                    <!-- Image à gauche -->
                    <div class="col-md-5 position-relative" style="overflow: hidden; min-height: 300px;">
                        {% if recipe.image %}
                            <img src="{{ recipe.image.url }}" class="img-fluid w-100 h-100" style="object-fit: cover;">
                        {% else %}
                            <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light">
                                <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Détails à droite -->
                    <div class="col-md-7 d-flex flex-column" style="overflow-y: auto; max-height: 80vh;"> 
                        <div class="modal-header">
                            <h5 class="modal-title" id="recipeModalLabel{{ recipe.id }}">{{ recipe.title }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <div class="p-4 flex-grow-1">
                            <!-- Métadonnées -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted"><i class="bi bi-calendar me-1"></i> {{ recipe.created_at|date:"d M Y" }}</small>
                                <span class="badge bg-primary-culinaire">{{ recipe.category }}</span>
                            </div>
                            
                            <p class="text-muted small mb-3">Par <strong>{{ recipe.author }}</strong></p>
                            
                            <!-- Note & Interactions -->
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <span class="text-warning-culinaire">
                                    <i class="bi bi-star-fill"></i> {{ recipe.avg_rating|default:"0"|floatformat:1 }}/5
                                </span>
                                <span class="text-primary-culinaire">
                                    <i class="bi bi-hand-thumbs-up-fill"></i> {{ recipe.likes_count }}
                                </span>
                                <span class="text-danger-culinaire">
                                    <i class="bi bi-heart-fill"></i> {{ recipe.fav_count }}
                                </span>
                                <span class="text-secondary-culinaire">
                                    <i class="bi bi-chat-left-text"></i> {{ recipe.comments.count }}
                                </span>
                            </div>
                            
                            <!-- Description -->
                            <h6 class="text-dark fw-semibold"><i class="bi bi-info-circle me-2"></i>Description :</h6>
                            <p class="small text-secondary mb-4">{{ recipe.description }}</p>
                            
                            <!-- Ingrédients -->
                            <h6 class="text-dark fw-semibold"><i class="bi bi-list-check me-2"></i>Ingrédients :</h6>
                            <ul class="small text-secondary mb-4">
                                {% for ingredient in recipe.ingredients.splitlines %}
                                    <li>{{ ingredient }}</li>
                                {% endfor %}
                            </ul>
                            
                            <!-- Instructions -->
                            <h6 class="text-dark fw-semibold"><i class="bi bi-list-ol me-2"></i>Instructions :</h6>
                            <ol class="small text-secondary">
                                {% for instruction in recipe.instructions.splitlines %}
                                    <li>{{ instruction }}</li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top 5 Favoris Notés -->
        <div class="col-md-6 col-lg-6">
            <div class="card shadow-sm border-0 h-100 dashboard-card">
                <div class="card-header text-white py-2 px-3 bg-info-culinaire">
                    <i class="bi bi-star-fill me-2"></i> Top 5 Favoris Notés
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Recette</th>
                                    <th class="text-end">Note</th>
                                    <th class="text-end">Avis</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fav in favoris_notes %}
                                    <tr>
                                        <td>
                                            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#recipeModal{{ fav.recipe.id }}">
                                                {{ fav.recipe.title }}
                                            </a>
                                            
                                            <!-- Modal pour la recette -->
                                            <div class="modal fade" id="recipeModal{{ fav.recipe.id }}" tabindex="-1" aria-labelledby="recipeModalLabel{{ fav.recipe.id }}" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered modal-lg">
                                                    <div class="modal-content border-0 rounded-3 overflow-hidden shadow-lg">
                                                        <div class="modal-body p-0 d-flex flex-column flex-md-row">
                                                            <!-- Image à gauche -->
                                                            <div class="col-md-5 position-relative" style="overflow: hidden; min-height: 300px;">
                                                                {% if fav.recipe.image %}
                                                                    <img src="{{ fav.recipe.image.url }}" class="img-fluid w-100 h-100" style="object-fit: cover;">
                                                                {% else %}
                                                                    <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light">
                                                                        <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            
                                                            <!-- Détails à droite -->
                                                            <div class="col-md-7 d-flex flex-column" style="overflow-y: auto; max-height: 80vh;"> 
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="recipeModalLabel{{ fav.recipe.id }}">{{ fav.recipe.title }}</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                                                </div>
                                                                <div class="p-4 flex-grow-1">
                                                                    <!-- Métadonnées -->
                                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                                        <small class="text-muted"><i class="bi bi-calendar me-1"></i> {{ fav.recipe.created_at|date:"d M Y" }}</small>
                                                                        <span class="badge bg-primary-culinaire">{{ fav.recipe.category }}</span>
                                                                    </div>
                                                                    
                                                                    <p class="text-muted small mb-3">Par <strong>{{ fav.recipe.author }}</strong></p>
                                                                    
                                                                    <!-- Note & Interactions -->
                                                                    <div class="d-flex align-items-center gap-3 mb-4">
                                                                        <span class="text-warning-culinaire">
                                                                            <i class="bi bi-star-fill"></i> {{ fav.recipe.avg_rating|default:"0"|floatformat:1 }}/5
                                                                        </span>
                                                                        <span class="text-primary-culinaire">
                                                                            <i class="bi bi-hand-thumbs-up-fill"></i> {{ fav.recipe.likes_count }}
                                                                        </span>
                                                                        <span class="text-danger-culinaire">
                                                                            <i class="bi bi-heart-fill"></i> {{ fav.recipe.fav_count }}
                                                                        </span>
                                                                        <span class="text-secondary-culinaire">
                                                                            <i class="bi bi-chat-left-text"></i> {{ fav.recipe.comments.count }}
                                                                        </span>
                                                                    </div>
                                                                    
                                                                    <!-- Description -->
                                                                    <h6 class="text-dark fw-semibold"><i class="bi bi-info-circle me-2"></i>Description :</h6>
                                                                    <p class="small text-secondary mb-4">{{ fav.recipe.description }}</p>
                                                                    
                                                                    <!-- Ingrédients -->
                                                                    <h6 class="text-dark fw-semibold"><i class="bi bi-list-check me-2"></i>Ingrédients :</h6>
                                                                    <ul class="small text-secondary mb-4">
                                                                        {% for ingredient in fav.recipe.ingredients.splitlines %}
                                                                            <li>{{ ingredient }}</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                    
                                                                    <!-- Instructions -->
                                                                    <h6 class="text-dark fw-semibold"><i class="bi bi-list-ol me-2"></i>Instructions :</h6>
                                                                    <ol class="small text-secondary">
                                                                        {% for instruction in fav.recipe.instructions.splitlines %}
                                                                            <li>{{ instruction }}</li>
                                                                        {% endfor %}
                                                                    </ol>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            {% if fav.avg_rating %}
                                                {% with ''|center:fav.avg_rating as range %}
                                                    {% for _ in range %}
                                                        <i class="bi bi-star-fill text-warning-culinaire"></i>
                                                    {% endfor %}
                                                {% endwith %}
                                                <span class="text-muted">({{ fav.avg_rating|floatformat:1 }})</span>
                                            {% else %}
                                                <span class="text-muted">Non notée</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">{{ fav.recipe.comments.count }} <i class="bi bi-chat-left-text text-secondary-culinaire"></i></td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center">Aucune recette en favoris</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Catégories par Note Moyenne -->
        <div class="col-md-12 col-lg-6">
            <div class="card shadow-sm border-0 h-100 dashboard-card">
                <div class="card-header text-white py-2 px-3 bg-dark-culinaire">
                    <i class="bi bi-award-fill me-2"></i> Top Catégories par Note Moyenne
                </div>
                <div class="card-body">
                    <canvas id="topCatChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Recettes sans interactions -->
        <div class="col-md-12 col-lg-6">
            <div class="card shadow-sm border-0 h-100 dashboard-card">
                <div class="card-header text-white py-2 px-3 bg-warning-culinaire">
                    <i class="bi bi-exclamation-triangle me-2"></i> Recettes sans interactions
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Recette</th>
                                    <th>Créée le</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for recipe in non_notees_ou_non_likées %}
                                    <tr>
                                        <td>
                                            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#recipeModal{{ recipe.id }}">
                                                {{ recipe.title }}
                                            </a>
                                            
                                            <!-- Modal pour la recette -->
                                            <div class="modal fade" id="recipeModal{{ recipe.id }}" tabindex="-1" aria-labelledby="recipeModalLabel{{ recipe.id }}" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered modal-lg">
                                                    <div class="modal-content border-0 rounded-3 overflow-hidden shadow-lg">
                                                        <div class="modal-body p-0 d-flex flex-column flex-md-row">
                                                            <!-- Image à gauche -->
                                                            <div class="col-md-5 position-relative" style="overflow: hidden; min-height: 300px;">
                                                                {% if recipe.image %}
                                                                    <img src="{{ recipe.image.url }}" class="img-fluid w-100 h-100" style="object-fit: cover;">
                                                                {% else %}
                                                                    <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light">
                                                                        <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            
                                                            <!-- Détails à droite -->
                                                            <div class="col-md-7 d-flex flex-column" style="overflow-y: auto; max-height: 80vh;"> 
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="recipeModalLabel{{ recipe.id }}">{{ recipe.title }}</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                                                </div>
                                                                <div class="p-4 flex-grow-1">
                                                                    <!-- Métadonnées -->
                                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                                        <small class="text-muted"><i class="bi bi-calendar me-1"></i> {{ recipe.created_at|date:"d M Y" }}</small>
                                                                        <span class="badge bg-primary-culinaire">{{ recipe.category }}</span>
                                                                    </div>
                                                                    
                                                                    <p class="text-muted small mb-3">Par <strong>{{ recipe.author }}</strong></p>
                                                                    
                                                                    <!-- Note & Interactions -->
                                                                    <div class="d-flex align-items-center gap-3 mb-4">
                                                                        <span class="text-warning-culinaire">
                                                                            <i class="bi bi-star-fill"></i> {{ recipe.avg_rating|default:"0"|floatformat:1 }}/5
                                                                        </span>
                                                                        <span class="text-primary-culinaire">
                                                                            <i class="bi bi-hand-thumbs-up-fill"></i> {{ recipe.likes_count }}
                                                                        </span>
                                                                        <span class="text-danger-culinaire">
                                                                            <i class="bi bi-heart-fill"></i> {{ recipe.fav_count }}
                                                                        </span>
                                                                        <span class="text-secondary-culinaire">
                                                                            <i class="bi bi-chat-left-text"></i> {{ recipe.comments.count }}
                                                                        </span>
                                                                    </div>
                                                                    
                                                                    <!-- Description -->
                                                                    <h6 class="text-dark fw-semibold"><i class="bi bi-info-circle me-2"></i>Description :</h6>
                                                                    <p class="small text-secondary mb-4">{{ recipe.description }}</p>
                                                                    
                                                                    <!-- Ingrédients -->
                                                                    <h6 class="text-dark fw-semibold"><i class="bi bi-list-check me-2"></i>Ingrédients :</h6>
                                                                    <ul class="small text-secondary mb-4">
                                                                        {% for ingredient in recipe.ingredients.splitlines %}
                                                                            <li>{{ ingredient }}</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                    
                                                                    <!-- Instructions -->
                                                                    <h6 class="text-dark fw-semibold"><i class="bi bi-list-ol me-2"></i>Instructions :</h6>
                                                                    <ol class="small text-secondary">
                                                                        {% for instruction in recipe.instructions.splitlines %}
                                                                            <li>{{ instruction }}</li>
                                                                        {% endfor %}
                                                                    </ol>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ recipe.created_at|date:"d/m/Y" }}</td>
                                        <td class="text-end">
                                            <a href="#" class="btn btn-sm btn-outline-primary-culinaire">
                                                <i class="bi bi-share"></i> Partager
                                            </a>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center">Toutes les recettes ont des interactions</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Nouvelle palette de couleurs harmonisée
    const colors = {
        primary: '#7e6060',         // Brun chaud profond
        secondary: '#8e7f7f',       // Brun clair
        success: '#5c5555',         // Vert nature
        danger: '#9e6c6c',          // Rouge vif
        warning: '#917e7e',         // Orange chaud
        info: '#405367',            // Bleu clair
        dark: '#342d2d',            // Brun foncé
        light: '#f1efee',           // Brun très clair
        accent: '#957c7c',          // Brun moyen
        text: '#342d2d'             // Brun très foncé pour texte
    };

    // Répartition par Catégorie - Doughnut
    new Chart(document.getElementById('catChart'), {
        type: 'doughnut',
        data: {
            labels: [{% for c in recettes_par_categorie %}'{{ c.category__name }}',{% endfor %}],
            datasets: [{
                data: [{% for c in recettes_par_categorie %}{{ c.count }},{% endfor %}],
                backgroundColor: [
                    colors.primary,
                    colors.secondary,
                    colors.success,
                    colors.info,
                    colors.warning,
                    colors.danger,
                    colors.accent,
                    colors.light
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12,
                        padding: 20,
                        font: {
                            family: "'Helvetica Neue', Arial, sans-serif"
                        },
                        color: colors.text
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });

    // Recettes par Mois - Ligne avec zone remplie
    new Chart(document.getElementById('moisChart'), {
        type: 'line',
        data: {
            labels: [{% for m in recettes_par_mois %}'{{ m.month|date:"M Y" }}',{% endfor %}],
            datasets: [{
                label: 'Recettes créées',
                data: [{% for m in recettes_par_mois %}{{ m.count }},{% endfor %}],
                borderColor: colors.primary,
                backgroundColor: hexToRgba(colors.primary, 0.2),
                fill: true,
                tension: 0.3,
                borderWidth: 3,
                pointBackgroundColor: colors.primary,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBorderColor: '#fff',
                pointBorderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { 
                        stepSize: 1,
                        font: {
                            family: "'Helvetica Neue', Arial, sans-serif"
                        },
                        color: colors.text
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            family: "'Helvetica Neue', Arial, sans-serif"
                        },
                        color: colors.text
                    }
                }
            }
        }
    });

    // Évolution des Likes par Mois - Barres verticales
    new Chart(document.getElementById('likesChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in likes_par_mois %}'{{ item.month|date:"M Y" }}',{% endfor %}],
            datasets: [{
                label: 'Likes',
                data: [{% for item in likes_par_mois %}{{ item.count }},{% endfor %}],
                backgroundColor: hexToRgba(colors.success, 0.8),
                borderColor: colors.success,
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)'
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        color: 'rgba(0,0,0,0.05)'
                    },
                    ticks: {
                        font: {
                            family: "'Helvetica Neue', Arial, sans-serif"
                        },
                        color: colors.text
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            family: "'Helvetica Neue', Arial, sans-serif"
                        },
                        color: colors.text
                    }
                }
            }
        }
    });

    // Top catégories par note moyenne - Barres horizontales
    new Chart(document.getElementById('topCatChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in top_categories_par_note %}'{{ item.category__name }}',{% endfor %}],
            datasets: [{
                label: 'Note Moyenne',
                data: [{% for item in top_categories_par_note %}{{ item.avg_rating|floatformat:1 }},{% endfor %}],
                backgroundColor: hexToRgba(colors.accent, 0.8),
                borderColor: colors.accent,
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.x}/5`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 5,
                    grid: {
                        drawBorder: false,
                        color: 'rgba(0,0,0,0.05)'
                    },
                    ticks: {
                        font: {
                            family: "'Helvetica Neue', Arial, sans-serif"
                        },
                        color: colors.text
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            family: "'Helvetica Neue', Arial, sans-serif"
                        },
                        color: colors.text
                    }
                }
            }
        }
    });

    // Fonction utilitaire pour convertir hex en rgba
    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
</script>

<style>
    /* Nouvelle palette de couleurs */
    :root {
        --primary-culinaire: #7e6060;       /* Couleur principale */
--secondary-culinaire: #8e7f7f;    /* Couleur secondaire */
--success-culinaire: #405367;      /* Succès (ton plus froid/bleuté) */
--danger-culinaire: #9e6c6c;       /* Danger */
--warning-culinaire: #957c7c;      /* Avertissement */
--info-culinaire: #5c5555;         /* Information (ton plus neutre) */
--dark-culinaire: #342d2d;         /* Foncé */
--light-culinaire: #f1efee;        /* Clair */
--accent-culinaire: #917e7e;       /* Accent */
--text-culinaire: #342d2d;         /* Texte principal (sombre) */
    }
    
    .bg-primary-culinaire { background-color: var(--primary-culinaire) !important; }
    .bg-secondary-culinaire { background-color: var(--secondary-culinaire) !important; }
    .bg-success-culinaire { background-color: var(--success-culinaire) !important; }
    .bg-danger-culinaire { background-color: var(--danger-culinaire) !important; }
    .bg-warning-culinaire { background-color: var(--warning-culinaire) !important; }
    .bg-info-culinaire { background-color: var(--info-culinaire) !important; }
    .bg-dark-culinaire { background-color: var(--dark-culinaire) !important; }
    
    .text-primary-culinaire { color: var(--primary-culinaire) !important; }
    .text-secondary-culinaire { color: var(--secondary-culinaire) !important; }
    .text-success-culinaire { color: var(--success-culinaire) !important; }
    .text-danger-culinaire { color: var(--danger-culinaire) !important; }
    .text-warning-culinaire { color: var(--warning-culinaire) !important; }
    .text-info-culinaire { color: var(--info-culinaire) !important; }
    .text-dark-culinaire { color: var(--dark-culinaire) !important; }
    
    .btn-outline-primary-culinaire {
        border-color: var(--primary-culinaire);
        color: var(--primary-culinaire);
    }
    
    .btn-outline-primary-culinaire:hover {
        background-color: var(--primary-culinaire);
        color: white;
    }

    /* Styles pour les modals */
    .custom-modal {
        max-width: 900px;
    }
    
    /* Styles supplémentaires pour harmoniser avec l'application */
    .dashboard-card {
        border-radius: 10px;
        overflow: hidden;
        transition: transform 0.2s ease-in-out;
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .card-header {
        font-weight: 600;
        font-size: 1rem;
        border-bottom: none;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(215, 204, 200, 0.3);
    }
    
    .table-light {
        background-color: var(--light-culinaire);
        color: var(--text-culinaire);
    }
    
    body {
        color: var(--text-culinaire);
    }
    
    h2 {
        color: var(--primary-culinaire);
    }
    
    /* Style pour les modals */
    .modal-content {
        border: none;
    }
    
    @media (max-width: 768px) {
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-body {
            flex-direction: column;
        }
        
        .modal-body > div {
            width: 100% !important;
        }
    }
</style>

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

{% endblock %}